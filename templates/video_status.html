<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ভিডিও প্লেয়ার - {{ video_id }}</title> <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f4; color: #333; margin: 0;}
        .container { max-width: 800px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #555; text-align: center; margin-bottom: 5px; }
        .video-id-display { text-align: center; font-size: 0.9em; color: #777; margin-bottom: 20px; word-wrap: break-word; }

        /* Plyr প্লেয়ার কন্টেইনার */
        .plyr--video {
             margin-bottom: 15px; /* নীচের লিঙ্কের সাথে স্পেস তৈরি করতে */
             /* আপনি চাইলে এখানে max-height যোগ করতে পারেন */
        }
        /* লোডিং এবং স্ট্যাটাস মেসেজের স্টাইল আগের মতোই */
        .status-message { text-align: center; padding: 30px; border-radius: 5px; margin-top: 20px; border: 1px solid; }
        .status-message.processing { background-color: #fffbe6; border-color: #ffe58f; color: #8a6d3b; }
        .status-message.error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .status-message.not-found { background-color: #e9ecef; border-color: #ced4da; color: #495057; }
        .status-message p { margin: 10px 0; font-size: 1.1em; font-weight: bold;}
        .status-message .sub-text { font-size: 0.9em; color: #666; font-weight: normal;}
        .error-details { margin-top: 15px; font-size: 0.9em; text-align: left; white-space: pre-wrap; background-color: #f1f1f1; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid #3498db; width: 40px; height: 40px; -webkit-animation: spin 1.5s linear infinite; animation: spin 1.5s linear infinite; margin: 20px auto; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .action-link { display: block; text-align: center; margin-top: 25px; }
        .action-link a { background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-size: 1em; }
        .action-link a:hover { background-color: #0056b3; }
        .flash-messages { list-style: none; padding: 0; margin-bottom: 15px; }
        .flash-messages li { padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .flash-messages .info { background-color: #d9edf7; color: #31708f; border: 1px solid #bce8f1; }
        .flash-messages .error { background-color: #f2dede; color: #a94442; border: 1px solid #ebccd1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ভিডিও প্লেয়ার</h1> <p class="video-id-display">আইডি: {{ video_id }}</p>

         {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
              <li class="{{ category if category else 'info' }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        {# --- স্ট্যাটাস অনুযায়ী কন্টেন্ট দেখানো শুরু --- #}
        {% if status == 'ready' %}
            <div id="player-wrapper">
                 <video controls crossorigin playsinline id="hls-player" style="width: 100%; height: auto;"></video>
            </div>

            <div class="action-link">
                <a href="{{ url_for('index') }}">নতুন ভিডিও আপলোড করুন</a>
            </div>

        {% elif status == 'processing' %}
            <div class="status-message processing">
                <p>অপেক্ষা করুন</p>
                <div class="loader"></div>
                <p class="sub-text">আপনার ভিডিও প্রক্রিয়া করা হচ্ছে। এটি সম্পূর্ণ হতে ফাইলের আকারের উপর নির্ভর করে কিছু সময় লাগতে পারে।</p>
             </div>
             <script>
                 // স্ট্যাটাস চেক ও রিফ্রেশ করার লজিক (আগের মতোই)
                 setTimeout(() => {
                    console.log("Checking status...");
                     fetch(window.location.href) // বর্তমান URL ফেচ করে স্ট্যাটাস চেক
                       .then(response => {
                           if (!response.ok) { throw new Error('Network response was not ok'); }
                           return response.text();
                        })
                       .then(html => {
                           const parser = new DOMParser();
                           const doc = parser.parseFromString(html, 'text/html');
                           // যদি লোডার এলিমেন্ট থাকে, তাহলে এখনো প্রসেসিং চলছে
                           if (doc.querySelector('.loader')) {
                               console.log("Still processing, reloading page...");
                               window.location.reload();
                           } else {
                               console.log("Processing seems finished or status changed. Stopping auto-reload.");
                           }
                       })
                       .catch(error => {
                            console.error("Error checking status:", error);
                            console.log("Error checking status, reloading page as fallback...");
                            setTimeout(() => window.location.reload(), 20000); // ত্রুটি ঘটলে একটু বেশি সময় পর রিফ্রেশ
                       });
                }, 15000); // ১৫ সেকেন্ড পর পর চেক
             </script>

        {% elif status == 'error' %}
            <div class="status-message error">
                <p>ভিডিও প্রক্রিয়াকরণে ত্রুটি</p>
                <p class="sub-text">এই ভিডিওটি প্রসেস করার সময় একটি সমস্যা হয়েছে।</p>
                {% if error %}
                    <div class="error-details">
                        <strong>ত্রুটির বিবরণ:</strong>
                        <pre>{{ error }}</pre>
                    </div>
                {% endif %}
             </div>
             <div class="action-link">
                <a href="{{ url_for('index') }}">নতুন ভিডিও আপলোড করার চেষ্টা করুন</a>
             </div>

        {% else %} {# status == 'not_found' or unknown #}
             <div class="status-message not-found">
                 <p>ভিডিও পাওয়া যায়নি</p>
                 <p class="sub-text">আপনি যে আইডিটি (`{{ video_id }}`) ব্যবহার করছেন, তার সাথে সম্পর্কিত কোনো ভিডিও খুঁজে পাওয়া যায়নি অথবা এটি এখনো আপলোড/প্রসেস করা হয়নি।</p>
             </div>
              <div class="action-link">
                <a href="{{ url_for('index') }}">নতুন ভিডিও আপলোড করুন</a>
             </div>
        {% endif %}
        {# --- স্ট্যাটাস অনুযায়ী কন্টেন্ট দেখানো শেষ --- #}

    </div> <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        // এই স্ক্রিপ্টটি শুধুমাত্র তখনই রান করবে যখন ভিডিও স্ট্যাটাস 'ready' হবে
        {% if status == 'ready' %}
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('hls-player');
            // নিশ্চিত করুন URL টি সঠিক
            const source = '/hls/{{ video_id }}/master.m3u8';

            // আপনার app.py তে RESOLUTIONS এ দেওয়া উচ্চতাগুলো এখানে লিস্ট করুন
            // এটি Plyr কে কোয়ালিটি মেনুতে সঠিক লেবেল দেখাতে সাহায্য করে
            // যদি কোনো রেজোলিউশন তৈরি না হয় (যেমন মূল ভিডিও 480p হলে 720p বাদ যাবে),
            // hls.js সেটি শনাক্ত করবে এবং Plyr শুধুমাত্র উপলব্ধ গুলোই দেখাবে।
            const availableQualities = [720, 480, 360]; // উচ্চতা অনুযায়ী সাজানো ভালো

            // Plyr প্লেয়ারের ডিফল্ট অপশন
            const defaultOptions = {
                 tooltips: { controls: true, seek: true },
                 // আপনি এখানে আরও অপশন যোগ করতে পারেন, যেমন:
                 // controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
            };

            // ব্রাউজার নেটিভ HLS সমর্থন করে কিনা চেক করুন (যেমন Safari)
            if (video.canPlayType('application/vnd.apple.mpegurl')) {
                console.log("নেটিভ HLS সমর্থন পাওয়া গেছে।");
                video.src = source;
                // নেটিভ HLS এর জন্য Plyr ইনিশিয়ালাইজ করুন
                const player = new Plyr(video, defaultOptions);
                window.player = player; // ডিবাগিংয়ের জন্য গ্লোবাল স্কোপে রাখুন (ঐচ্ছিক)
                console.log("Plyr player initialized for native HLS.");

            } else if (Hls.isSupported()) {
                // অন্যান্য ব্রাউজারের জন্য hls.js ব্যবহার করুন
                console.log("Hls.js ব্যবহার করে HLS প্লেব্যাক সেটআপ করা হচ্ছে।");
                const hls = new Hls({
                    // আপনি এখানে hls.js এর কনফিগারেশন যোগ করতে পারেন
                    // যেমন: capLevelToPlayerSize: true // 플레이어 크기에 맞춰 품질 제한
                });

                hls.loadSource(source); // HLS সোর্স লোড করুন

                // hls.js কে ভিডিও এলিমেন্টের সাথে বাইন্ড করুন
                hls.attachMedia(video);

                // Plyr কে hls.js এর সাথে কাজ করতে বলুন
                // এটি নিশ্চিত করে যে Plyr hls.js থেকে কোয়ালিটি লেভেল পাবে
                window.hls = hls; // <<<--- Plyr এর ইন্টিগ্রেশনের জন্য এটি গুরুত্বপূর্ণ

                // hls.js প্রস্তুত হওয়ার পর Plyr ইনিশিয়ালাইজ করুন
                const player = new Plyr(video, {
                    ...defaultOptions, // আগের অপশনগুলো অন্তর্ভুক্ত করুন
                    // --- কোয়ালিটি সিলেকশন কনফিগারেশন ---
                    quality: {
                       default: 480, // ডিফল্টরূপে কোন কোয়ালিটি সিলেক্ট থাকবে (যেমন 480p)
                                     // hls.js এটিকে ওভাররাইড করতে পারে যদি অ্যাডাপ্টিভ বিটরেট ভালো কাজ করে
                       options: availableQualities, // উপলব্ধ কোয়ালিটির তালিকা (উচ্চতা)
                       forced: false, // true দিলে প্লেয়ার সবসময় ডিফল্ট কোয়ালিটি ব্যবহার করবে (অ্যাডাপ্টিভ বন্ধ)
                       onChange: (quality) => {
                           console.log('Plyr: কোয়ালিটি পরিবর্তিত হয়েছে:', quality);
                           // আপনি চাইলে এখানে অতিরিক্ত কাজ করতে পারেন
                           // যেমন: UI তে বর্তমান কোয়ালিটি দেখানো
                           // hls.js স্বয়ংক্রিয়ভাবে স্ট্রিম পরিবর্তন করবে
                       },
                    },
                });

                window.player = player; // ডিবাগিংয়ের জন্য (ঐচ্ছিক)
                console.log("Plyr player initialized with hls.js support.");

                // hls.js এর ইভেন্ট শোনা (ঐচ্ছিক কিন্তু ডিবাগিংয়ের জন্য সহায়ক)
                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    console.log("HLS manifest পার্স হয়েছে। উপলব্ধ লেভেল:", data.levels.length);
                    // আপনি এখানে data.levels দেখতে পারেন উপলব্ধ কোয়ালিটিগুলো নিশ্চিত করার জন্য
                    // data.levels.forEach(level => console.log(level.height, level.bitrate));
                });

                hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                    var newLevel = data.level;
                    console.log("HLS.js লেভেল পরিবর্তন করেছে:", hls.levels[newLevel].height + "p");
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS.js Error:', data);
                     if (data.fatal) {
                        switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.error('HLS.js: Fatal network error.');
                            // hls.startLoad(); // রিকভারির চেষ্টা করতে পারেন
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.error('HLS.js: Fatal media error.');
                            // hls.recoverMediaError(); // রিকভারির চেষ্টা করতে পারেন
                            break;
                        default:
                            console.error('HLS.js: Unrecoverable error.');
                            // hls.destroy(); // instance ধ্বংস করা যেতে পারে
                            break;
                        }
                    }
                });

            } else {
                // যদি ব্রাউজার HLS বা hls.js কোনোটিই সমর্থন না করে
                console.error('দুঃখিত, আপনার ব্রাউজার HLS সমর্থন করে না।');
                const playerWrapper = document.getElementById('player-wrapper');
                 if(playerWrapper) {
                    playerWrapper.innerHTML = '<p style="color: red; text-align: center; padding: 20px; border: 1px solid red; border-radius: 4px;">দুঃখিত, আপনার ব্রাউজার HLS ভিডিও প্লেব্যাক সমর্থন করে না।</p>';
                 }
            }
        });
        {% endif %} // status == 'ready' শেষ
    </script>

</body>
</html>
