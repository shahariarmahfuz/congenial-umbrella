<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ভিডিও স্ট্যাটাস - {{ video_id }}</title>

    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f4; color: #333; margin: 0;}
        .container { max-width: 800px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #555; text-align: center; margin-bottom: 5px; }
        .video-id-display { text-align: center; font-size: 0.9em; color: #777; margin-bottom: 20px; word-wrap: break-word; }

        /* Plyr প্লেয়ার কন্টেইনার */
        .plyr__video-embed {
             /* আপনি এখানে অতিরিক্ত স্টাইল যোগ করতে পারেন */
             margin-bottom: 15px; /* নীচের লিঙ্কের সাথে স্পেস তৈরি করতে */
        }

        /* স্ট্যাটাস মেসেজ ও অন্যান্য স্টাইল আগের মতোই থাকবে */
        .status-message { text-align: center; padding: 30px; border-radius: 5px; margin-top: 20px; border: 1px solid; }
        .status-message.processing { background-color: #fffbe6; border-color: #ffe58f; color: #8a6d3b; }
        .status-message.error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .status-message.not-found { background-color: #e9ecef; border-color: #ced4da; color: #495057; }
        .status-message p { margin: 10px 0; font-size: 1.1em; font-weight: bold;}
        .status-message .sub-text { font-size: 0.9em; color: #666; font-weight: normal;}
        .error-details { margin-top: 15px; font-size: 0.9em; text-align: left; white-space: pre-wrap; background-color: #f1f1f1; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid #3498db; width: 40px; height: 40px; -webkit-animation: spin 1.5s linear infinite; animation: spin 1.5s linear infinite; margin: 20px auto; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .action-link { display: block; text-align: center; margin-top: 25px; }
        .action-link a { background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-size: 1em; }
        .action-link a:hover { background-color: #0056b3; }
        .flash-messages { list-style: none; padding: 0; margin-bottom: 15px; }
        .flash-messages li { padding: 10px; margin-bottom: 10px; border-radius: 4px; }
        .flash-messages .info { background-color: #d9edf7; color: #31708f; border: 1px solid #bce8f1; }
        .flash-messages .error { background-color: #f2dede; color: #a94442; border: 1px solid #ebccd1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ভিডিও স্ট্যাটাস</h1>
        <p class="video-id-display">আইডি: {{ video_id }}</p>

         {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
              <li class="{{ category if category else 'info' }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        {% if status == 'ready' %}
            <div class="plyr__video-embed" id="player-container">
                 <video controls crossorigin playsinline id="hls-player"></video>
            </div>

            <div class="action-link">
                <a href="{{ url_for('index') }}">নতুন ভিডিও আপলোড করুন</a>
            </div>

        {% elif status == 'processing' %}
            <div class="status-message processing">
                <p>অপেক্ষা করুন</p>
                <div class="loader"></div>
                <p class="sub-text">আপনার ভিডিও প্রক্রিয়া করা হচ্ছে। এটি সম্পূর্ণ হতে ফাইলের আকারের উপর নির্ভর করে কিছু সময় লাগতে পারে।</p>
             </div>
             <script>
                 // আগের মতোই স্ট্যাটাস চেক ও রিফ্রেশ করার লজিক
                 setTimeout(() => {
                    console.log("Checking status...");
                     fetch(window.location.href)
                       .then(response => {
                           if (!response.ok) { throw new Error('Network response was not ok'); }
                           return response.text();
                        })
                       .then(html => {
                           const parser = new DOMParser();
                           const doc = parser.parseFromString(html, 'text/html');
                           if (doc.querySelector('.loader')) {
                               console.log("Still processing, reloading page...");
                               window.location.reload();
                           } else {
                               console.log("Processing seems finished or status changed. Stopping auto-reload.");
                           }
                       })
                       .catch(error => {
                            console.error("Error checking status:", error);
                            console.log("Error checking status, reloading page as fallback...");
                            setTimeout(() => window.location.reload(), 20000);
                       });
                }, 15000);
             </script>

        {% elif status == 'error' %}
            <div class="status-message error">
                <p>ভিডিও প্রক্রিয়াকরণে ত্রুটি</p>
                <p class="sub-text">এই ভিডিওটি প্রসেস করার সময় একটি সমস্যা হয়েছে।</p>
                {% if error %}
                    <div class="error-details">
                        <strong>ত্রুটির বিবরণ:</strong>
                        <pre>{{ error }}</pre>
                    </div>
                {% endif %}
             </div>
             <div class="action-link">
                <a href="{{ url_for('index') }}">নতুন ভিডিও আপলোড করার চেষ্টা করুন</a>
             </div>

        {% else %} {# status == 'not_found' or unknown #}
             <div class="status-message not-found">
                 <p>ভিডিও পাওয়া যায়নি</p>
                 <p class="sub-text">আপনি যে আইডিটি (`{{ video_id }}`) ব্যবহার করছেন, তার সাথে সম্পর্কিত কোনো ভিডিও খুঁজে পাওয়া যায়নি অথবা এটি এখনো আপলোড/প্রসেস করা হয়নি।</p>
             </div>
              <div class="action-link">
                <a href="{{ url_for('index') }}">নতুন ভিডিও আপলোড করুন</a>
             </div>
        {% endif %}

    </div> <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // শুধুমাত্র 'ready' স্ট্যাটাসেই প্লেয়ার সেটআপ করুন
            {% if status == 'ready' %}
                const video = document.getElementById('hls-player');
                const source = '/hls/{{ video_id }}/master.m3u8'; // আপনার HLS মাস্টারের URL

                // ব্যাকএন্ডে ব্যবহৃত রেজোলিউশনগুলো এখানে উল্লেখ করুন
                // এটি Plyr কে কোয়ালিটি মেনুতে সঠিক লেবেল দেখাতে সাহায্য করে
                const availableQualities = [720, 480, 360]; // app.py তে RESOLUTIONS অনুযায়ী

                const defaultOptions = {
                     // এখানে Plyr এর কাস্টম অপশন যোগ করতে পারেন
                     tooltips: { controls: true, seek: true },
                     // captions: { active: true, language: 'auto', update: true }, // সাবটাইটেল থাকলে
                };

                // প্রথমে চেক করুন ব্রাউজার নেটিভভাবে HLS সমর্থন করে কিনা (যেমন Safari)
                if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    console.log("নেটিভ HLS সমর্থন পাওয়া গেছে (যেমন Safari)।");
                    video.src = source;
                    // নেটিভ HLS এর জন্য Plyr ইনিশিয়ালাইজ করুন (কোয়ালিটি অপশন এখানে কম কার্যকর হতে পারে)
                    const player = new Plyr(video, defaultOptions);
                    window.player = player; // গ্লোবাল স্কোপে রাখুন ডিবাগিংয়ের জন্য (ঐচ্ছিক)

                } else if (Hls.isSupported()) {
                    // যেসব ব্রাউজার নেটিভভাবে HLS সমর্থন করে না, তাদের জন্য hls.js ব্যবহার করুন
                    console.log("Hls.js ব্যবহার করে HLS প্লেব্যাক শুরু হচ্ছে।");
                    const hls = new Hls();
                    hls.loadSource(source);

                    // hls.js কে ভিডিও এলিমেন্টের সাথে বাইন্ড করুন
                    hls.attachMedia(video);

                    // Plyr কে hls.js এর সাথে কাজ করতে বলুন
                    // hls.js লোড হওয়ার পর Plyr ইনিশিয়ালাইজ করা জরুরি
                    const player = new Plyr(video, {
                        ...defaultOptions, // আগের অপশনগুলো অন্তর্ভুক্ত করুন
                        quality: {
                           default: 480, // ডিফল্ট কোয়ালিটি (অপশনাল, hls.js অটো সিলেক্ট করতে পারে)
                           options: availableQualities, // উপলব্ধ কোয়ালিটির তালিকা (hls.js থেকে প্রাপ্ত লেভেলের সাথে ম্যাচ করার জন্য)
                           forced: false, // শুরুতে অ্যাডাপ্টিভ বিটরেট ব্যবহার করতে দিন
                           onChange: (quality) => console.log('কোয়ালিটি পরিবর্তিত হয়েছে:', quality),
                        },
                    });

                    window.hls = hls; // Plyr এর ইন্টিগ্রেশনের জন্য hls instance কে window অবজেক্টে যোগ করুন
                    window.player = player; // গ্লোবাল স্কোপে রাখুন ডিবাগিংয়ের জন্য (ঐচ্ছিক)

                     // hls.js এর লেভেল লোড হওয়ার পর কোয়ালিটি অপশন আপডেট হতে পারে
                     hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                        console.log("HLS ম্যানিফেস্ট পার্স হয়েছে, লেভেলস:", data.levels);
                        // এখানে player.quality আপডেট করার প্রয়োজন হতে পারে যদি ডায়নামিকভাবে করতে চান
                        // কিন্তু সাধারণত Plyr এর quality.options কনফিগারেশনই যথেষ্ট
                    });

                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS.js Error:', data);
                         if (data.fatal) {
                            switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.error('Fatal network error encountered, trying to recover...');
                                // hls.startLoad(); // রিকভারির চেষ্টা
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.error('Fatal media error encountered, trying to recover...');
                                // hls.recoverMediaError(); // রিকভারির চেষ্টা
                                break;
                            default:
                                // cannot recover
                                console.error('Unrecoverable HLS error', data);
                                // hls.destroy(); // দরকার হলে hls instance ধ্বংস করুন
                                break;
                            }
                        }
                    });

                } else {
                    console.error('দুঃখিত, আপনার ব্রাউজার HLS সমর্থন করে না।');
                    // একটি ফলব্যাক বার্তা দেখাতে পারেন
                     const playerContainer = document.getElementById('player-container');
                     if(playerContainer) {
                        playerContainer.innerHTML = '<p style="color: red; text-align: center;">দুঃখিত, আপনার ব্রাউজার HLS ভিডিও প্লেব্যাক সমর্থন করে না।</p>';
                     }
                }
            {% endif %} // status == 'ready' শেষ
        });
    </script>

</body>
</html>
