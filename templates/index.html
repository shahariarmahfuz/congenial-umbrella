<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS ভিডিও প্লেয়ার</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f4; color: #333; margin: 0;}
        .container { max-width: 800px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #555; text-align: center; margin-bottom: 20px; }
        #videoPlayer { width: 100%; max-width: 100%; border: 1px solid #ccc; background-color: #000; }
        .status-message { text-align: center; padding: 30px; background-color: #e9f5ff; border: 1px solid #b3d7ff; border-radius: 5px; margin-top: 20px; }
        .status-message.processing { background-color: #fffbe6; border-color: #ffe58f; }
        .status-message p { margin: 0; font-size: 1.1em; color: #31708f; }
        .status-message.processing p { color: #8a6d3b; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 30px; height: 30px; -webkit-animation: spin 2s linear infinite; animation: spin 2s linear infinite; margin: 10px auto; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .upload-link { display: block; text-align: center; margin-top: 20px; }
        .upload-link a { background-color: #007bff; color: white; padding: 10px 15px; text-decoration: none; border-radius: 4px; }
        .upload-link a:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>HLS ভিডিও স্ট্রিমিং</h1>

        {% if hls_ready %}
            <video id="videoPlayer" controls></video>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    var video = document.getElementById('videoPlayer');
                    // Ensure this path correctly points to your master playlist
                    var videoSrc = '/hls/master.m3u8'; // Master playlist path

                    if (Hls.isSupported()) {
                        var hls = new Hls();
                        console.log("HLS.js সমর্থিত। লোড হচ্ছে:", videoSrc);
                        hls.loadSource(videoSrc);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, function() {
                            console.log("ম্যানিফেস্ট পার্স করা হয়েছে। প্লে শুরু হচ্ছে...");
                            video.play().catch(e => console.error("প্লেব্যাক শুরু করতে সমস্যা:", e));
                        });
                        hls.on(Hls.Events.ERROR, function (event, data) {
                            console.error('HLS.js ত্রুটি:', data);
                            if (data.fatal) {
                                switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.error("মারাত্মক নেটওয়ার্ক ত্রুটি ঘটেছে", data);
                                    // নেটওয়ার্ক সমস্যা হলে আবার চেষ্টা করার চেষ্টা করতে পারে
                                    // hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.error("মারাত্মক মিডিয়া ত্রুটি ঘটেছে", data);
                                    // hls.recoverMediaError(); // ত্রুটি পুনরুদ্ধারের চেষ্টা
                                    break;
                                default:
                                    // পুনরুদ্ধার করা যায় না এমন ত্রুটি, hls instance ধ্বংস করুন
                                    console.error("পুনরুদ্ধারযোগ্য নয় এমন ত্রুটি, HLS ধ্বংস হচ্ছে।");
                                    hls.destroy();
                                    break;
                                }
                            }
                        });
                    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                        // নেটিভ HLS সমর্থন (যেমন Safari তে)
                        console.log("নেটিভ HLS সমর্থন পাওয়া গেছে।");
                        video.src = videoSrc;
                        video.addEventListener('loadedmetadata', function() {
                           video.play().catch(e => console.error("প্লেব্যাক শুরু করতে সমস্যা:", e));
                        });
                         video.addEventListener('error', function(e) {
                            console.error('নেটিভ HLS প্লেয়ার ত্রুটি:', video.error);
                        });
                    } else {
                        alert('দুঃখিত, আপনার ব্রাউজার HLS স্ট্রিমিং সমর্থন করে না।');
                        console.error('HLS সমর্থিত নয়।');
                    }
                });
            </script>
            <div class="upload-link">
                <a href="{{ url_for('index') }}">নতুন ভিডিও আপলোড করুন</a>
            </div>

        {% elif processing %}
            <div class="status-message processing">
                <p>আপনার ভিডিও প্রসেস করা হচ্ছে...</p>
                <div class="loader"></div>
                <p style="font-size: 0.9em; color: #666;">বড় ফাইলের জন্য এতে কিছু সময় লাগতে পারে। পৃষ্ঠাটি রিফ্রেশ করবেন না।</p>
             </div>
             <script>
                // প্রতি 10 সেকেন্ডে পৃষ্ঠাটি রিফ্রেশ করুন যাতে স্ট্যাটাস আপডেট দেখা যায়
                setTimeout(() => {
                    window.location.reload();
                }, 10000); // 10000 মিলিসেকেন্ড = 10 সেকেন্ড
             </script>

        {% else %}
            <div class="status-message">
                 <p>কোনো ভিডিও প্লে করার জন্য প্রস্তুত নেই।</p>
             </div>
             <div class="upload-link">
                 <a href="{{ url_for('index') }}">এখনই একটি ভিডিও আপলোড করুন</a>
             </div>
        {% endif %}

    </div> </body>
</html>
