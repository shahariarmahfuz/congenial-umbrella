<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ç (Plyr - ‡¶≤‡ßá‡¶¨‡ßá‡¶≤ ‡¶∏‡¶π)</title>

    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; color: #212529; }
        h1 { color: #007bff; text-align: center; }
        .container {
            max-width: 800px;
            margin: 30px auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        :root {
          --plyr-color-main: #007bff;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            font-size: 1.1em;
            text-align: center;
        }
        .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #player-container.hidden { display: none; }
    </style>
</head>
<body>
    <h1>HLS ‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø-‡¶ï‡ßã‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ç (Plyr - ‡¶≤‡ßá‡¶¨‡ßá‡¶≤ ‡¶∏‡¶π)</h1>

    <div class="container">
        {% if error %}
            <div class="status error">
                <strong>‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:</strong> <pre style="white-space: pre-wrap; text-align: left;">{{ error }}</pre>
            </div>
             <div id="player-container" class="hidden">
                 <video id="player" controls crossorigin playsinline></video>
             </div>

        {% elif processing %}
             <div class="status info">
                ‚è≥ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶ö‡¶≤‡¶õ‡ßá... ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ï‡ßç‡¶∑‡¶£ ‡¶™‡¶∞ ‡¶™‡ßá‡¶ú‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
             </div>
             <div id="player-container" class="hidden">
                 <video id="player" controls crossorigin playsinline></video>
             </div>

        {% elif hls_ready %}
            <div class="status success">
                ‚úÖ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ç‡ßü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡•§ ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </div>
            <div id="player-container">
                 <video id="player" controls crossorigin playsinline></video>
            </div>

        {% else %}
             <div class="status info">
                ü§î ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡¶®‡¶ø‡•§
             </div>
             <div id="player-container" class="hidden">
                 <video id="player" controls crossorigin playsinline></video>
             </div>
        {% endif %}
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        {% if hls_ready %}
          const video = document.getElementById('player');
          if (!video) {
            console.error("Plyr ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
            return;
          }

          const source = '/hls/master.m3u8';
          let player = null;
          let hlsInstance = null;

          if (Hls.isSupported()) {
            console.log("HLS.js ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶ø‡¶§‡•§ hls.js ‡¶¶‡¶ø‡ßü‡ßá ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
            hlsInstance = new Hls({ /* HLS config options */ });

            hlsInstance.on(Hls.Events.ERROR, function (event, data) {
              console.error('HLS Error:', data);
              if (data.fatal) {
                switch (data.type) {
                  case Hls.ErrorTypes.NETWORK_ERROR: hlsInstance.startLoad(); break;
                  case Hls.ErrorTypes.MEDIA_ERROR: hlsInstance.recoverMediaError(); break;
                  default:
                    if (player) player.destroy();
                    if (hlsInstance) hlsInstance.destroy();
                    break;
                }
              }
            });

            hlsInstance.attachMedia(video);

            hlsInstance.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
              console.log('HLS ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶´‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶≤‡ßá‡¶≠‡ßá‡¶≤:', data.levels);

              if (data.levels && data.levels.length > 1) {
                    const sortedLevels = [...data.levels].sort((a, b) => b.bitrate - a.bitrate);
                    const qualityOptionsBitrates = sortedLevels.map(level => level.bitrate);
                    console.log('‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø (‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü):', qualityOptionsBitrates);

                    // --- ‡¶≤‡ßá‡¶¨‡ßá‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ---
                    const qualityLabelsMap = {};
                    sortedLevels.forEach(level => {
                         // ‡¶Ø‡¶¶‡¶ø level.height ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü, ‡¶§‡¶æ‡¶π‡¶≤‡ßá '720p' ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶ø
                         // ‡¶®‡¶æ‡¶π‡¶≤‡ßá, ‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü ‡¶ï‡ßá kbps ‡¶è ‡¶¶‡ßá‡¶ñ‡¶æ‡¶á
                        const label = level.height ? `${level.height}p` : `${Math.round(level.bitrate / 1000)} kbps`;
                        qualityLabelsMap[level.bitrate] = label; // key = bitrate, value = label
                    });
                    console.log('‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶≤‡ßá‡¶¨‡ßá‡¶≤:', qualityLabelsMap);
                    // --- ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç ‡¶§‡ßà‡¶∞‡¶ø ‡¶∂‡ßá‡¶∑ ---

                    // Plyr ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ (i18n ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∏‡¶π)
                    player = new Plyr(video, {
                        quality: {
                            default: sortedLevels[0].bitrate, // ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü
                            options: qualityOptionsBitrates, // ‡¶Ö‡¶™‡¶∂‡¶® ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶ó‡ßÅ‡¶≤‡ßã‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
                            forced: true,
                            onChange: (selectedBitrate) => {
                                console.log("‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü):", selectedBitrate);
                                let newLevelIndex = hlsInstance.levels.findIndex(level => level.bitrate === selectedBitrate);
                                if (newLevelIndex !== -1) {
                                    console.log(`HLS ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶á‡¶®‡ßç‡¶°‡ßá‡¶ï‡ßç‡¶∏ ${newLevelIndex} ‡¶è`);
                                    hlsInstance.currentLevel = newLevelIndex;
                                } else {
                                    console.warn(`‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü ${selectedBitrate} ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï (-1) ‡¶è ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§`);
                                    hlsInstance.currentLevel = -1;
                                }
                            },
                        },
                        // --- i18n ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ---
                        i18n: {
                            qualityLabel: qualityLabelsMap // ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶≤‡ßá‡¶¨‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶æ
                            // ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶≤‡ßá‡¶¨‡ßá‡¶≤‡¶ì ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®
                            // quality: 'Quality',
                            // speed: 'Speed',
                            // normal: 'Normal',
                        }
                        // --- i18n ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∂‡ßá‡¶∑ ---
                    });

                    window.player = player;
                    window.hls = hlsInstance;

              } else {
                  console.warn("HLS ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶´‡ßá‡¶∏‡ßç‡¶ü‡ßá ‡¶è‡¶ï‡¶ü‡¶ø‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
                  player = new Plyr(video, {});
                  window.player = player;
                  window.hls = hlsInstance;
              }
            });

            hlsInstance.loadSource(source);

          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                console.warn("HLS.js ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶ø‡¶§ ‡¶®‡ßü, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶®‡ßá‡¶ü‡¶ø‡¶≠ HLS ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá‡•§ ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶ï‡¶æ‡¶ú ‡¶®‡¶æ‡¶ì ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§");
                video.src = source;
                player = new Plyr(video, {});
                window.player = player;
          } else {
            console.error("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ HLS ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶® ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§");
            const container = document.getElementById('player-container');
            if(container) container.innerHTML = '<div class="status error">‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ HLS ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶® ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§</div>';
          }

        {% else %}
           console.log("HLS ‡¶è‡¶ñ‡¶®‡¶ì ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶®‡ßü‡•§ ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
           const playerContainer = document.getElementById('player-container');
           if(playerContainer) playerContainer.classList.add('hidden');
        {% endif %}
      });
    </script>

</body>
</html>
