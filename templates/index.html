<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶°‡ßç‡¶∞‡¶™‡¶¨‡¶ï‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá HLS ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ç (Plyr - ‡¶≤‡ßá‡¶¨‡ßá‡¶≤ ‡¶∏‡¶π)</title>

    <link rel="stylesheet" href="[https://cdn.plyr.io/3.7.8/plyr.css](https://cdn.plyr.io/3.7.8/plyr.css)" />
    <script src="[https://cdn.jsdelivr.net/npm/hls.js@latest](https://cdn.jsdelivr.net/npm/hls.js@latest)"></script>
    <script src="[https://cdn.plyr.io/3.7.8/plyr.js](https://cdn.plyr.io/3.7.8/plyr.js)"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; color: #212529; }
        h1 { color: #007bff; text-align: center; }
        .container {
            max-width: 800px;
            margin: 30px auto;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        :root {
          --plyr-color-main: #007bff;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            font-size: 1.1em;
            text-align: center;
        }
        .status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #player-container.hidden { display: none; }
        /* ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶ï‡ßã‡¶° ‡¶¨‡¶æ ‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶†‡¶ø‡¶ï‡¶Æ‡¶§‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
        .status pre {
             white-space: pre-wrap; /* Wrap long lines */
             word-wrap: break-word; /* Break long words */
             text-align: left;     /* Align text left for readability */
             max-height: 200px;    /* Limit height */
             overflow-y: auto;     /* Add scroll if needed */
             background-color: #f1f1f1; /* Slight background */
             padding: 10px;
             margin-top: 10px;
             border-radius: 4px;
             font-family: monospace; /* Use monospace font */
        }
    </style>
</head>
<body>
    <h1>‡¶°‡ßç‡¶∞‡¶™‡¶¨‡¶ï‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá HLS ‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø-‡¶ï‡ßã‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ç (Plyr)</h1>

    <div class="container">
        {% if error %}
            <div class="status error">
                <strong>‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:</strong> <pre>{{ error }}</pre>
            </div>
             <div id="player-container" class="hidden">
                 <video id="player" controls crossorigin playsinline></video>
             </div>

        {% elif processing %}
             <div class="status info">
                ‚è≥ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç (‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°, ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü, ‡¶°‡ßç‡¶∞‡¶™‡¶¨‡¶ï‡ßç‡¶∏ ‡¶Ü‡¶™‡¶≤‡ßã‡¶°) ‡¶ö‡¶≤‡¶õ‡ßá... ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ï‡ßç‡¶∑‡¶£ ‡¶™‡¶∞ ‡¶™‡ßá‡¶ú‡¶ü‡¶ø ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
             </div>
             <div id="player-container" class="hidden">
                 <video id="player" controls crossorigin playsinline></video>
             </div>

        {% elif hls_ready and dropbox_master_playlist_url %}
            <div class="status success">
                ‚úÖ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶°‡ßç‡¶∞‡¶™‡¶¨‡¶ï‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡¶Ç‡ßü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡•§ ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
            </div>
            <div id="player-container">
                 <video id="player" controls crossorigin playsinline></video>
            </div>

        {% else %}
             {# This case might indicate an issue if processing isn't running and it's not ready #}
             <div class="status info">
                ü§î ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡¶®‡¶ø/‡¶Ö‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
             </div>
             <div id="player-container" class="hidden">
                 <video id="player" controls crossorigin playsinline></video>
             </div>
        {% endif %}
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Use the variables passed from Flask
        const hlsReady = {{ hls_ready | tojson }}; // Boolean
        const dropboxMasterPlaylistUrl = {{ dropbox_master_playlist_url | tojson }}; // String or null

        if (hlsReady && dropboxMasterPlaylistUrl) {
          console.log("HLS ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶°‡ßç‡¶∞‡¶™‡¶¨‡¶ï‡ßç‡¶∏ URL ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá:", dropboxMasterPlaylistUrl);
          const video = document.getElementById('player');
          if (!video) {
            console.error("Plyr ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§");
            return;
          }

          // *** Use the Dropbox URL as the source ***
          const source = dropboxMasterPlaylistUrl;
          let player = null;
          let hlsInstance = null;

          if (Hls.isSupported()) {
            console.log("HLS.js ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶ø‡¶§‡•§ hls.js ‡¶¶‡¶ø‡ßü‡ßá ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
            hlsInstance = new Hls({
                 // Optional: Add HLS.js config here if needed
                 // Example: Increase buffer size
                 // maxBufferLength: 60, // seconds
            });

            hlsInstance.on(Hls.Events.ERROR, function (event, data) {
              console.error('HLS Error:', data);
              // Basic error recovery
              if (data.fatal) {
                switch (data.type) {
                  case Hls.ErrorTypes.NETWORK_ERROR:
                    console.warn('HLS Network error - trying to recover by restarting load...');
                    hlsInstance.startLoad();
                    break;
                  case Hls.ErrorTypes.MEDIA_ERROR:
                     console.warn('HLS Media error - trying to recover...');
                    hlsInstance.recoverMediaError();
                    break;
                  default:
                    console.error('Unrecoverable HLS error. Destroying HLS instance.');
                    if (hlsInstance) hlsInstance.destroy();
                    // Optionally update UI to show error
                    const container = document.getElementById('player-container');
                    if(container) container.innerHTML = '<div class="status error">‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡ßã‡¶° ‡¶π‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ HLS Error: ' + data.details + '</div>';
                    break;
                }
              }
            });

            // Bind hls.js to the video element
            hlsInstance.attachMedia(video);

            // Wait for the manifest to be parsed
            hlsInstance.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
              console.log('HLS ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶´‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶≤‡ßá‡¶≠‡ßá‡¶≤:', data.levels);

              // --- Quality Selection Logic ---
              if (data.levels && data.levels.length > 0) { // Check if at least one level exists
                    // Sort levels by bitrate (highest first) for default selection
                    const sortedLevels = [...data.levels].sort((a, b) => b.bitrate - a.bitrate);
                    const qualityOptionsBitrates = sortedLevels.map(level => level.bitrate);
                    console.log('‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø (‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü):', qualityOptionsBitrates);

                    // Create labels for the quality options
                    const qualityLabelsMap = {};
                    sortedLevels.forEach(level => {
                        // Prefer height (e.g., '720p') if available, otherwise use bitrate in kbps
                        const label = level.height ? `${level.height}p` : `${Math.round(level.bitrate / 1000)} kbps`;
                        qualityLabelsMap[level.bitrate] = label; // key = bitrate, value = display label
                    });
                    console.log('‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶≤‡ßá‡¶¨‡ßá‡¶≤:', qualityLabelsMap);

                    // Initialize Plyr with quality options
                    player = new Plyr(video, {
                        debug: false, // Set to true for verbose Plyr logs
                        quality: {
                            default: sortedLevels[0].bitrate, // Default to highest quality bitrate
                            options: qualityOptionsBitrates, // Pass the array of bitrates
                            forced: true, // Force the use of hls.js for quality switching
                            onChange: (selectedBitrate) => {
                                console.log("Plyr: ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü):", selectedBitrate);
                                if (hlsInstance) {
                                     // Find the hls.js level index corresponding to the selected bitrate
                                     let newLevelIndex = hlsInstance.levels.findIndex(level => level.bitrate === selectedBitrate);
                                     if (newLevelIndex !== -1) {
                                         console.log(`Plyr: HLS ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶á‡¶®‡ßç‡¶°‡ßá‡¶ï‡ßç‡¶∏ ${newLevelIndex} ‡¶è`);
                                         hlsInstance.currentLevel = newLevelIndex; // Manual switch
                                     } else {
                                         console.warn(`Plyr: ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶¨‡¶ø‡¶ü‡¶∞‡ßá‡¶ü ${selectedBitrate} HLS ‡¶≤‡ßá‡¶≠‡ßá‡¶≤‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶Ö‡¶ü‡ßã (-1) ‡¶§‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§`);
                                         hlsInstance.currentLevel = -1; // Let hls.js decide (auto mode)
                                     }
                                }
                            },
                        },
                        i18n: {
                            // Provide the generated labels to Plyr
                            qualityLabel: qualityLabelsMap,
                            // You can add more translations if needed
                            // quality: 'Quality',
                            // speed: 'Speed',
                            // normal: 'Normal',
                            // settings: '‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏', // Example Bengali translation
                            // fullscreen: '‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡¶∞‡ßç‡¶¶‡¶æ', // Example
                        },
                        // Add controls if needed, default Plyr controls are usually sufficient
                        // controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
                    });

                    window.player = player; // Make accessible globally for debugging
                    window.hls = hlsInstance;

              } else {
                  // No multiple quality levels found or levels array is empty
                  console.warn("HLS ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶´‡ßá‡¶∏‡ßç‡¶ü‡ßá ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø ‡¶¨‡¶æ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
                  // Initialize Plyr without quality options
                  player = new Plyr(video, { /* Basic Plyr config if needed */ });
                  window.player = player;
                  window.hls = hlsInstance; // hlsInstance might still be useful
              }
            });

            // Load the source URL (Dropbox link) into hls.js
            console.log("HLS ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá:", source);
            hlsInstance.loadSource(source);

          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Fallback for browsers with native HLS support (like Safari)
                // Quality selection might not work natively as well as with hls.js
                console.warn("HLS.js ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶ø‡¶§ ‡¶®‡ßü, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶®‡ßá‡¶ü‡¶ø‡¶≠ HLS ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá (‡¶Ø‡ßá‡¶Æ‡¶® Safari)‡•§ ‡¶ï‡ßã‡ßü‡¶æ‡¶≤‡¶ø‡¶ü‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ ‡¶ï‡¶æ‡¶ú ‡¶®‡¶æ‡¶ì ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§");
                video.src = source; // Set the Dropbox URL directly
                player = new Plyr(video, { /* Basic Plyr config */ });
                window.player = player;
          } else {
            // HLS is not supported at all
            console.error("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ HLS ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶® ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§");
            const container = document.getElementById('player-container');
            if(container) container.innerHTML = '<div class="status error">‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ HLS ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶® ‡¶ï‡¶∞‡ßá ‡¶®‡¶æ‡•§</div>';
          }

        } else if (!hlsReady && !{{ processing | tojson }} && !{{ error | tojson }}) {
             // Optional: Handle the edge case where processing hasn't started yet
             console.log("HLS ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶®‡ßü, ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶ö‡¶≤‡¶õ‡ßá ‡¶®‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßã‡¶®‡¶ì ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶®‡ßá‡¶á‡•§ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨‡¶§ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...");
             // You might want to add a poller here to refresh the page after a delay,
             // or rely on the user refreshing manually.
             // setTimeout(() => { window.location.reload(); }, 30000); // Example: Refresh after 30s
        }
        else {
           // Covers 'processing' state or 'error' state
           console.log("HLS ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶®‡ßü ‡¶¨‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶∞‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßç‡¶≤‡ßá‡ßü‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
           const playerContainer = document.getElementById('player-container');
           if(playerContainer) playerContainer.classList.add('hidden'); // Keep player hidden
        }
      });
    </script>

</body>
</html>
